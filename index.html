from flask import Flask, render_template_string, request, redirect, url_for
import os, requests, time
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.config[ UPLOAD_FOLDER ] = "static/uploads"
os.makedirs(app.config[ UPLOAD_FOLDER ], exist_ok=True)

# ========== ğŸ”‘ Ø¶Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€API Ù‡Ù†Ø§ Ø£Ùˆ ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© ==========
API_KEY = os.getenv("A1D_API_KEY", "https://a1d.ai/api/nano-banana/edit")
# ==========================================================

TEMPLATE =    
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù…ÙˆÙ‚Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ± - Ø±ÙˆÙ†ÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body{background:#f8f9fa}
    .editor-wrap{max-width:980px;margin:20px auto}
    #canvasWrap{position:relative;width:100%;height:560px;border:1px solid #ddd;background:#000;overflow:hidden}
    video#bgvideo{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:cover;z-index:1}
    canvas#composite{position:absolute;left:0;top:0;z-index:2}
    img#editedImg{display:none}
    .watermark{position:absolute;left:10px;bottom:10px;z-index:3;pointer-events:none;opacity:0.5;color:#fff;font-weight:700}
    .api-highlight{box-shadow:0 0 12px rgba(255,200,0,0.9);border:2px solid rgba(255,200,0,0.6)}
    .note-danger{background:#fff3cd;border-left:4px solid #ffe08a;padding:10px;margin-bottom:10px}
  </style>
</head>
<body>
<div class="container editor-wrap">
  <h3 class="mb-3">Ø£Ø¯Ø§Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø®Ù„ÙÙŠØ© ÙÙŠØ¯ÙŠÙˆ â€” Ø±ÙˆÙ†ÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡</h3>

  <div class="note-danger">
    <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</strong> Ø¶Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€API Ù‡Ù†Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. <u>Ø£ÙØ²ÙÙ„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‚Ø¨Ù„ Ø±ÙØ¹ Ø§Ù„ÙƒÙˆØ¯ Ø¹Ù„Ù‰ GitHub</u> Ø£Ùˆ Ø¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ù…ØªØºÙŠÙ‘Ø± Ø¨ÙŠØ¦Ø© (A1D_API_KEY).
  </div>

  <form method="post" action="/upload" enctype="multipart/form-data" class="mb-3">
    <div class="mb-2">
      <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ù„ÙÙŠ</label>
      <input class="form-control" name="bg_name" placeholder="Ù…Ø«Ø§Ù„: your-video.mp4" value="your-video.mp4">
    </div>

    <div class="row">
      <div class="col-md-6 mb-2">
        <label class="form-label">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© (Square)</label>
        <input class="form-control" type="file" name="square" accept="image/*">
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù…Ø³ØªØ·ÙŠÙ„Ø© (Rectangle)</label>
        <input class="form-control" type="file" name="rect" accept="image/*">
      </div>
    </div>

    <div class="mb-2">
      <label class="form-label">ÙˆØµÙ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Prompt)</label>
      <input class="form-control" name="prompt" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ø«Ù„: Ø§Ø¬Ø¹Ù„ Ø§Ù„ÙˆÙ„Ø¯ ÙŠØ­Ø¶Ù† Ø§Ù„Ø¨Ù†Øª">
    </div>

    <div class="mb-2">
      <label class="form-label">API Key (Ø¶Ø¹ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€API Ù‡Ù†Ø§ Ø§Ùˆ Ø¶Ø¹Ù‡ ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø©)</label>
      <input class="form-control api-highlight" name="api_key" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ù€API Ù‡Ù†Ø§ (Ø§Ø­Ø°ÙÙ‡ Ù‚Ø¨Ù„ Ø±ÙØ¹ Ø§Ù„ÙƒÙˆØ¯)">
      <small class="text-muted">Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ø¨Ø§Ø³Ù… <code>A1D_API_KEY</code>.</small>
    </div>

    <button class="btn btn-primary">Ø§Ø±Ø³Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</button>
  </form>

  {% if edited_path %}
  <div class="mb-3">
    <p>Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø§Ù‡Ø²Ø© â€” Ø§Ø³Ø­Ø¨ Ù„Ù…Ø¹Ø§ÙŠÙ†ØªÙ‡Ø§ ØªØ­Øª</p>
  </div>
  {% endif %}

  <div id="canvasWrap">
    <video id="bgvideo" autoplay muted loop playsinline>
      <source src="/static/backgrounds/{{ bg_name }}" type="video/mp4">
      Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
    </video>
    <canvas id="composite"></canvas>
    <img id="editedImg" src="/{{ edited_path if edited_path else    }}" crossorigin="anonymous">
    <div class="watermark">Ø±ÙˆÙ†Ù€Ù€ÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡</div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button id="downloadBtn" class="btn btn-success">ØªÙ†Ø²ÙŠÙ„</button>
    <button id="shareBtn" class="btn btn-outline-primary">Ù…Ø´Ø§Ø±ÙƒØ©</button>
    <a class="btn btn-secondary" href="/">Ø±Ø¬ÙˆØ¹</a>
  </div>

  <footer class="mt-4 text-center small text-muted">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ Ø±ÙˆÙ†ÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡ 2025</footer>
</div>

<script>
const video = document.getElementById( bgvideo );
const canvas = document.getElementById( composite );
const ctx = canvas.getContext( 2d );
const editedImg = document.getElementById( editedImg );
const watermarkText =  Ø±ÙˆÙ†Ù€Ù€ÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡ ;

function fitCanvas(){
  const wrap = document.getElementById( canvasWrap );
  canvas.width = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
}
window.addEventListener( resize , fitCanvas);
fitCanvas();

function drawFrame(){
  try{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    if(editedImg && editedImg.complete && editedImg.naturalWidth){
      const targetW = canvas.width * 0.5;
      const aspect = editedImg.naturalWidth / editedImg.naturalHeight;
      const targetH = targetW / aspect;
      const x = (canvas.width - targetW)/2;
      const y = (canvas.height - targetH)/2;
      ctx.drawImage(editedImg, x, y, targetW, targetH);
    }
    ctx.globalAlpha = 0.5;
    ctx.font =  24px Arial ;
    ctx.fillStyle =  #ffffff ;
    ctx.fillText(watermarkText, 12, canvas.height - 12);
    ctx.globalAlpha = 1.0;
  }catch(e){ console.log( draw error , e); }
  requestAnimationFrame(drawFrame);
}
video.addEventListener( play , ()=>{ requestAnimationFrame(drawFrame); });

document.getElementById( downloadBtn ).addEventListener( click , ()=>{
  const data = canvas.toDataURL( image/png );
  const a = document.createElement( a );
  a.href = data;
  a.download =  edited_with_bg.png ;
  a.click();
});

document.getElementById( shareBtn ).addEventListener( click , async ()=>{
  if(navigator.share){
    canvas.toBlob(async blob=>{
      const filesArray = [new File([blob],  edited.png , {type: image/png })];
      try{ await navigator.share({files: filesArray, title:  ØµÙˆØ±Ø© Ù…Ø¹Ø¯Ù„Ø© , text:  ØµÙˆØ±Ø© Ù…Ù† Ø±ÙˆÙ†ÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ù‡ }); }
      catch(err){ alert( Ù…Ø´Ø§Ø±ÙƒØ© ÙØ´Ù„Øª:  +err); }
    });
  } else {
    alert( Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø«Ù… Ø´Ø§Ø±Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹. );
  }
});
</script>
</body>
</html>
   

def edit_image(image_path, prompt, api_key):
    url = "https://a1d.ai/api/nano-banana/edit"
    res = requests.post(url,
                        headers={"Authorization": f"Bearer {api_key}"},
                        json={
                            "prompt": prompt,
                            "images": [image_path],
                            "enable_base64_output": False
                        }).json()
    job_id = res[ data ][ id ]
    for _ in range(10):
        status = requests.get(f"https://a1d.ai/api/nano-banana/status?id={job_id}",
                              headers={"Authorization": f"Bearer {api_key}"}).json()
        if len(status[ data ][ outputs ]) == 1:
            return status[ data ][ outputs ][0]
        time.sleep(5)
    return None

@app.route("/", methods=["GET"])
def index():
    return render_template_string(TEMPLATE, edited_path=None, bg_name="your-video.mp4")

@app.route("/upload", methods=["POST"])
def upload():
    prompt = request.form.get("prompt", "")
    bg_name = request.form.get("bg_name", "your-video.mp4")
    api_key = request.form.get("api_key") or API_KEY

    file = request.files.get("square") or request.files.get("rect")
    if not file:
        return redirect(url_for("index"))

    filename = secure_filename(file.filename)
    file_path = os.path.join(app.config[ UPLOAD_FOLDER ], filename)
    file.save(file_path)

    edited_url = edit_image(file_path, prompt, api_key)

    return render_template_string(TEMPLATE, edited_path=edited_url, bg_name=bg_name)

if __name__ == "__main__":
    app.run(debug=True)
		
